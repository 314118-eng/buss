<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å…¬è»Šå°å¹«æ‰‹ï½œè¦ä¸è¦ç­‰é€™ç­ï¼Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ===== å…¨åŸŸè¨­è¨ˆç³»çµ± (Design System) ===== */
    :root {
      /* é¡è‰² */
      --color-primary: #00b894; 
      --color-primary-dark: #009475;
      --color-secondary: #4a69bd; 
      --color-background: #f4f7f6; 
      --color-surface: #ffffff; 
      --color-text-main: #1b282b; 
      --color-text-soft: #2b2a2a; 
      --color-border: #dfe6e9; 
      --color-shadow: rgba(0, 0, 0, 0.05);

      /* å°ºå¯¸ */
      --radius-lg: 16px; 
      --radius-md: 10px; 
      --spacing-md: 12px;
      --spacing-lg: 16px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--color-background);
      color: var(--color-text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      max-width: 420px;
      width: 100%;
      background-color: var(--color-surface);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .app-top-bg {
      position: absolute;
      top: 0; left: 0; right: 0;
      /* ä¿®æ”¹ 1ï¼šå°‡åŸæœ¬çš„ 180px ç¸®çŸ­ç‚º 135px */
      height: 145px;
      background: linear-gradient(135deg, #00b894, #00cec9);
      z-index: 0;
    }

    header.app-header {
      padding: 16px var(--spacing-lg) 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--color-surface);
      position: relative;
      z-index: 1;
    }

    header h1 { font-size: 18px; font-weight: 600; }
    header h1 span { font-size: 13px; font-weight: 400; opacity: 0.8; }
    .header-right { font-size: 12px; text-align: right; line-height: 1.4; }

    main {
      flex: 1;
      padding: 0 var(--spacing-lg);
      overflow-y: auto;
      position: relative;
      z-index: 1;
      padding-bottom: 20px;
    }

    .screen {
      display: none;
      animation: fadeIn 0.25s ease-out;
      padding-bottom: 20px;
    }
    .screen.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Bottom Nav */
    .bottom-nav {
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 60px;
      background-color: var(--color-surface);
      border-top: 1px solid var(--color-border);
      box-shadow: 0 -2px 10px var(--color-shadow);
      position: sticky;
      bottom: 0;
      z-index: 10;
    }

    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4px 0;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 10px;
      color: var(--color-text-soft);
      transition: color 0.2s ease;
    }
    .nav-btn.active { color: var(--color-primary); }
    .nav-icon { font-size: 22px; margin-bottom: 2px; }
    .nav-btn.active .nav-icon { filter: hue-rotate(100deg) saturate(200%); }

    /* Common Components */
    .card {
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      box-shadow: 0 4px 12px var(--color-shadow);
      margin-bottom: var(--spacing-md);
    }

    .btn {
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background-color 0.2s, transform 0.1s;
    }
    .btn-primary {
      background-color: var(--color-primary);
      color: var(--color-surface);
      box-shadow: 0 4px 10px rgba(0, 184, 148, 0.3);
    }
    .btn-primary:active { transform: translateY(1px); }
    
    .btn-secondary {
      background-color: var(--color-background);
      color: var(--color-text-main);
      border: 1px solid var(--color-border);
    }
    
    .btn-outline {
      background-color: transparent;
      color: var(--color-secondary);
      border: 1px solid var(--color-secondary);
    }
    .btn-outline:active { background-color: #f0f4ff; }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin: 16px 0 8px;
      color: var(--color-text-main);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .hint-text { font-size: 12px; color: var(--color-text-soft); margin-bottom: 10px; }

    /* Home Screen */
    .location-card {
      display: flex; align-items: flex-start; justify-content: space-between; gap: 8px;
    }
    .location-main { display: flex; align-items: flex-start; gap: 10px; font-size: 14px; max-width: 60%; }
    .location-tag {
      background-color: #e8f6f3; color: var(--color-primary-dark);
      border-radius: 999px; padding: 2px 10px; font-size: 11px; margin-top: 4px;
      display: inline-flex; align-items: center; gap: 4px;
    }
    .location-right {
      display: flex; flex-direction: column; align-items: flex-end; gap: 6px;
      font-size: 12px; text-align: right; max-width: 40%;
    }
    .location-right-title { font-weight: 600; color: var(--color-primary-dark); display: flex; align-items: center; gap: 4px; font-size: 12px; }
    .location-right-weather { color: var(--color-text-soft); }
    .weather-link { border: none; background: transparent; font-size: 11px; color: var(--color-primary-dark); text-decoration: underline; cursor: pointer; padding: 0; }

    /* Bus List */
    .bus-list-container {
      display: flex; flex-direction: column; background-color: var(--color-surface);
      border-radius: var(--radius-lg); box-shadow: 0 4px 12px var(--color-shadow); overflow: hidden;
    }
    .home-bus-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; border-bottom: 1px solid var(--color-border);
      background-color: var(--color-surface); cursor: pointer; transition: background-color 0.2s ease;
    }
    .home-bus-row:last-child { border-bottom: none; }
    .home-bus-row:hover { background-color: #f9f9f9; }
    
    .arrival-circle {
      width: 50px; height: 50px; border: 2px solid var(--color-border); border-radius: 50%;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 15px; font-weight: 700; color: var(--color-text-main); flex-shrink: 0;
    }
    .arrival-circle.urgent { border-color: #ff6b6b; color: #ff6b6b; }
    .arrival-circle span { font-size: 10px; font-weight: 400; }
    
    .bus-name { font-size: 16px; font-weight: 700; color: var(--color-text-main); display: flex; align-items: center; gap: 4px; }
    .bus-dest { font-size: 13px; color: var(--color-text-soft); }
    .icon-accessible { font-size: 24px; color: #4a69bd; margin-left: 4px; vertical-align: middle; }

    /* Detail/Decision Screen */
    .decision-card { padding: 20px; margin-bottom: 10px; }
    .decision-header { display: flex; align-items: center; gap: 15px; }
    .emoji-bus {
      width: 50px; height: 50px; border-radius: 12px; background: var(--color-background);
      display: flex; align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0;
    }
    .decision-main-title { font-size: 20px; font-weight: 700; }
    .decision-subtitle { font-size: 14px; color: var(--color-text-soft); margin-top: 4px; }
    .decision-tag {
      display: inline-flex; align-items: center; gap: 6px; border-radius: 999px;
      padding: 6px 12px; font-size: 12px; margin-top: 8px; font-weight: 600;
    }
    .decision-tag.good { background: #e4ffe8; color: #186638; }
    .decision-tag.ok { background: #fff4cf; color: #8a5900; }
    .decision-tag.bad { background: #ffe4e4; color: #a52222; }

    .props-card { margin-top: 15px; background: var(--color-background); padding: 15px; border-radius: var(--radius-md); }
    .props-list { list-style: none; display: flex; flex-direction: column; gap: 8px; }
    .props-item { display: flex; gap: 8px; align-items: baseline; font-size: 12px; }
    .props-label { font-weight: 600; min-width: 80px; flex-shrink: 0; }
    .props-value { color: var(--color-text-soft); font-size: 12px; }

    .actions-row { display: flex; gap: 10px; margin-top: 20px; }

    /* Food Screen */
    .food-header-card {
        background-color: #fff8e1; /* æ·¡æ·¡çš„é»ƒè‰²èƒŒæ™¯ */
        border: 1px solid #ffe082;
        color: #f57f17;
        /* ä¿®æ”¹ï¼šè®“ä¸‹æ‹‰é¸å–®æ’ç‰ˆæ›´å¥½çœ‹ */
        display: flex; 
        align-items: center; 
        gap: 6px; 
        font-weight: 600; 
        font-size: 13px;
        padding: 10px;
    }
    /* ä¿®æ”¹ï¼šæ–°å¢ä¸‹æ‹‰é¸å–®æ¨£å¼ */
    .food-select {
        flex: 1;
        border: 1px solid #ffe082;
        background: #fff;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 13px;
        color: #e67e22;
        font-weight: 600;
        cursor: pointer;
    }
    .food-select:focus { outline: none; border-color: #f57f17; }

    .food-item {
      display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--color-border);
    }
    .food-item:last-child { border-bottom: none; }
    .food-img {
      width: 60px; height: 60px; background-color: #eee; border-radius: 8px;
      display: flex; align-items: center; justify-content: center; font-size: 30px;
    }
    .food-info h4 { font-size: 15px; margin-bottom: 4px; }
    .food-meta { font-size: 12px; color: var(--color-text-soft); }

    /* Reservation Screen List Headers */
    .res-group-title {
        font-size: 14px; font-weight: 700; color: var(--color-secondary);
        margin: 15px 0 8px; padding-left: 4px; border-left: 3px solid var(--color-secondary);
        line-height: 1.2;
    }

    /* Stop Card */
    .stop-card {
      display: flex; flex-direction: column; gap: 4px; margin-bottom: 10px; font-size: 13px;
    }
    .chip-btn {
      border-radius: 999px; border: none; font-size: 11px; padding: 4px 8px; cursor: pointer;
      display: inline-flex; align-items: center; gap: 4px;
    }

    /* Countdown */
    #countdown-text { color: var(--color-primary); font-weight: bold; font-size: 14px; margin-top: 10px; }

  </style>
</head>
<body>
  <div class="app">
    <div class="app-top-bg"></div>
    <header class="app-header">
      <div class="header-left">
        <div class="bus-icon" style="background-color: var(--color-surface); color: var(--color-primary); width: 32px; height: 32px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px;">ğŸšŒ</div>
        <h1 style="display: inline-block; vertical-align: middle;">
          å…¬è»Šå°å¹«æ‰‹<br />
          <span>è¦ä¸è¦ç­‰é€™ç­ï¼Ÿ</span>
        </h1>
      </div>
      <div class="header-right">
        <div>ğŸ“ ç›®å‰ä½ç½®</div>
        <div id="header-weather">å¤©æ°£å®šä½ä¸­...</div>
      </div>
    </header>

    <main>
      <section id="welcome-screen" class="screen active">
        <div class="welcome-wrap" style="height: 100%; padding-top: 80px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center;">
          <div class="welcome-emoji" style="width: 90px; height: 90px; border-radius: 32px; margin: 0 auto 10px; background: var(--color-primary); color: var(--color-surface); box-shadow: 0 10px 24px rgba(0, 184, 148, 0.3); display: flex; align-items: center; justify-content: center; font-size: 42px;">ğŸ‘‹</div>
          <div style="margin-top: 20px; font-size: 24px; font-weight: 700;">æ­¡è¿ä½¿ç”¨å…¬è»Šå°å¹«æ‰‹</div>
          <p style="color: var(--color-text-soft); margin-bottom: 20px;">é€£çµ Firebase<br>è®“ AI å¹«ä½ æ±ºå®šå…¬è»Šå€¼ä¸å€¼å¾—ç­‰ï¼</p>
          <div id="countdown-text">3 ç§’å¾Œè‡ªå‹•é€²å…¥...</div>
          <button id="btn-start" class="btn btn-primary" style="margin-top: 20px;">ç«‹å³é–‹å§‹ï¼Œå‰å¾€é¦–é </button>
        </div>
      </section>

      <section id="home-screen" class="screen">
        <div class="card location-card">
          <div class="location-main">
            <span class="icon" style="font-size: 24px;">ğŸ </span>
            <div>
              <div style="font-weight: 600; margin-bottom: 3px;">æˆ‘çš„å¸¸ç”¨ç«™ç‰Œ</div>
              <div class="location-tag">åªé¡¯ç¤ºæ”¶è—è·¯ç·š</div>
            </div>
          </div>
          <div class="location-right">
            <div class="location-right-title"><span class="icon">â˜€ï¸</span>å³æ™‚å¤©æ°£</div>
            <div class="location-right-weather">
              <span id="weather-text">å®šä½ä¸­...</span>
              <button class="weather-link" id="btn-refresh-weather">æ›´æ–°</button>
            </div>
          </div>
        </div>

        <div class="section-title"><span style="font-size: 24px;">ğŸšŒ</span> å³å°‡åˆ°ç«™å…¬è»Š</div>
        <p class="hint-text">ä»¥ä¸‹ç‚ºæ‚¨å·²æ”¶è—çš„ç«™ç‰Œè·¯ç·šï¼š</p>

        <div class="bus-list-container" id="bus-list">
          <div style="padding: 20px; text-align: center; color: #888;">æ­£åœ¨å¾è³‡æ–™åº«è¼‰å…¥è·¯ç·š...</div>
        </div>
        
        <div style="text-align:center; margin-top:15px;">
           <button id="btn-to-stops-main" class="btn btn-secondary" style="font-size:12px;">â• æ–°å¢å¸¸ç”¨ç«™ç‰Œ</button>
        </div>
      </section>

      <section id="stops-screen" class="screen">
        <div class="section-title"><span style="font-size: 24px;">â­</span> å¸¸ç”¨ç«™ç‰Œç®¡ç†</div>
        <p class="hint-text">è¨­å®šæ‚¨å¸¸ç”¨çš„ç«™ç‰Œï¼Œæ–¹ä¾¿å¿«é€Ÿåˆ‡æ›æŸ¥çœ‹å³æ™‚è³‡è¨Šã€‚</p>
        <div id="stops-list"></div>
        <button id="btn-add-stop" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">â• æ–°å¢å¸¸ç”¨ç«™ç‰Œ</button>
      </section>

      <section id="reservations-screen" class="screen">
        <div class="section-title"><span style="font-size: 24px;">ğŸ“</span> é ç´„ç´€éŒ„</div>
        <p class="hint-text">ç³»çµ±å°‡æœƒåœ¨æ™‚é–“åˆ°æ™‚ç™¼å‡ºé€šçŸ¥ã€‚</p>
        
        <div id="res-list-boarding">
           <div class="res-group-title">ğŸš ä¸Šè»Šæé†’</div>
           <div class="content"></div>
        </div>
        
        <div id="res-list-alighting" style="margin-top: 20px;">
           <div class="res-group-title">ğŸš¶ ä¸‹è»Šæé†’</div>
           <div class="content"></div>
        </div>
        
        <p class="hint-text" style="text-align: center; margin-top: 20px; display: none;" id="no-reservation-text">
          ç›®å‰æ²’æœ‰é ç´„ç´€éŒ„ã€‚
        </p>
      </section>

      <section id="route-screen" class="screen">
        <div class="section-title"><span style="font-size: 24px;">ğŸ¦­</span> è¦åŠƒè·¯ç·š</div>
        <p class="hint-text">è¼¸å…¥ç›®çš„åœ°ï¼Œé–‹å•Ÿ Google Maps å°èˆªã€‚</p>
        <section class="route-planner-card card" style="padding: 0; margin-top: 20px;">
          <div class="route-form" style="padding: var(--spacing-md);">
            <div class="route-input-group" style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
              <div style="display: flex; flex-direction: column; align-items: center; justify-content: space-between; height: 60px;">
                <span style="font-size: 18px; color: var(--color-primary); font-weight: 700;">â—</span>
                <span style="width: 2px; height: 20px; background-color: var(--color-border);"></span>
                <span style="font-size: 18px; color: var(--color-secondary);">ğŸ“</span>
              </div>
              <div style="flex-grow: 1;">
                <input type="text" placeholder="æ‚¨çš„ä½ç½® (è‡ªå‹•åµæ¸¬)" readonly style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: var(--radius-md); margin-bottom: 5px; font-size: 14px; background-color: #f9f9f9; color: var(--color-text-soft);"/>
                <input id="destInput" type="text" placeholder="è«‹è¼¸å…¥ç›®çš„åœ° (ä¾‹å¦‚: æ¡ƒåœ’ç«è»Šç«™)" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 14px; background-color: var(--color-surface);"/>
              </div>
            </div>
            <button id="btn-plan-route" type="button" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
              ğŸ—ºï¸ é–‹å•Ÿ Google Maps å°èˆª
            </button>
          </div>
          <div style="padding: 15px; color: #666; font-size: 13px; line-height: 1.5;">
             èªªæ˜ï¼šé»æ“ŠæŒ‰éˆ•å°‡é–‹å•Ÿ Google åœ°åœ– APPï¼Œè‡ªå‹•å¸¶å…¥æ‚¨çš„ç›®å‰ä½ç½®ä½œç‚ºèµ·é»ã€‚
          </div>
        </section>
      </section>

      <section id="others-screen" class="screen">
        <div class="section-title"><span style="font-size: 24px;">ğŸ”</span> åˆ°ç«™ç¾é£Ÿæ¨è–¦</div>
        
        <div class="card food-header-card" id="food-location-container">
           <span>ğŸ“</span>
           <label for="food-stop-select">é™„è¿‘ç«™ç‰Œï¼š</label>
           <select id="food-stop-select" class="food-select">
               <option value="">è«‹é¸æ“‡...</option>
           </select>
        </div>

        <p class="hint-text">çœ‹çœ‹é€™å€‹ç«™ç‰Œé™„è¿‘æœ‰ä»€éº¼å¥½åƒçš„ï¼(åˆ‡æ›ç«™ç‰Œå¯åˆ·æ–°æ¨è–¦)</p>
        
        <div class="card" id="food-list-container">
            <div style="text-align:center; padding:10px;">è«‹é¸æ“‡ç«™ç‰Œä»¥è¼‰å…¥ç¾é£Ÿ</div>
        </div>
      </section>

      <section id="detail-screen" class="screen">
        <button class="btn btn-secondary" type="button" id="btn-back" style="margin-bottom: 15px;">â† è¿”å›é¦–é </button>

        <div id="decision-card" class="decision-card">
          <div class="decision-header">
            <div id="emoji-bus" class="emoji-bus">ğŸšŒ</div>
            <div>
              <div id="decision-title" class="decision-main-title">åˆ†æå®Œæˆ</div>
              <div id="decision-subtitle" class="decision-subtitle">åˆ†æä¸­...</div>
            </div>
          </div>

          <div id="decision-tag" class="decision-tag" style="margin-top: 15px;"><span>ğŸ¤”</span> è©•ä¼°ä¸­</div>

          <div id="bus-name-line" style="font-size: 14px; color: var(--color-text-main); margin-top: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--color-border);">è³‡è¨Šè¼‰å…¥ä¸­â€¦</div>

          <div class="props-card">
            <div style="font-size: 14px; font-weight: 700; margin-bottom: 10px; color: var(--color-text-main);">æœ¬æ¬¡åˆ¤æ–·ä¾æ“šï¼š</div>
            <ul id="props-list" class="props-list"></ul>
          </div>

          <div class="actions-row">
            <button class="btn btn-primary" type="button" id="btn-reserve-board" style="flex: 1;">
              ğŸ”” ä¸Šè»Šæé†’
            </button>
            <button class="btn btn-outline" type="button" id="btn-reserve-alight" style="flex: 1;">
              ğŸ”• ä¸‹è»Šæé†’
            </button>
          </div>

          <div class="small-note">
            â€» ä¸Šè»Šæé†’å°‡ä¾æ“šå³æ™‚åˆ°ç«™æ™‚é–“é€šçŸ¥ã€‚<br>
            â€» ä¸‹è»Šæé†’å°‡æ¨¡æ“¬ä¸€æ®µè»Šç¨‹å¾Œé€šçŸ¥ã€‚
          </div>
        </div>
      </section>
    </main>

    <div id="add-stop-modal" class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 20;">
      <div class="modal-card card" style="width: 90%; max-width: 350px; padding: 20px; text-align: center;">
        <div class="modal-title" style="font-size: 20px; font-weight: 700; margin-bottom: 10px;">æ–°å¢å¸¸ç”¨ç«™ç‰Œ</div>
        <div class="modal-row" style="text-align: left; margin-bottom: 15px;">
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">é¸æ“‡è·¯ç·š</label>
          <select id="select-route-firebase" style="width: 100%; padding: 10px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 14px;"><option value="">è¼‰å…¥ä¸­...</option></select>
        </div>
        <div class="modal-row" style="text-align: left; margin-bottom: 20px;">
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">é¸æ“‡ç«™ç‰Œ</label>
          <select id="select-stop-firebase" disabled style="width: 100%; padding: 10px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 14px; background-color: #f0f0f0;"><option value="">è«‹å…ˆé¸æ“‡è·¯ç·š</option></select>
        </div>
        <div class="modal-actions" style="display: flex; gap: 10px;">
          <button type="button" id="btn-add-stop-cancel" class="btn btn-secondary" style="flex: 1;">å–æ¶ˆ</button>
          <button type="button" id="btn-add-stop-confirm" class="btn btn-primary" style="flex: 1;">æ–°å¢</button>
        </div>
      </div>
    </div>
    
    <div id="reserve-overlay" class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 20;">
      <div class="modal-card card" style="width: 90%; max-width: 350px; padding: 20px;">
        <div style="font-size: 18px; font-weight: 700; margin-bottom: 10px;">é ç´„æˆåŠŸ</div>
        <p id="reserve-msg">å·²åŠ å…¥é ç´„ç´€éŒ„ã€‚</p>
        <button id="btn-modal-ok" class="btn btn-primary" style="width:100%; margin-top:10px;">ç¢ºå®š</button>
      </div>
    </div>
    
    <div id="notification-overlay" class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 30;">
      <div class="modal-card card" style="width: 90%; max-width: 350px; padding: 20px; border-left: 5px solid #00b894;">
        <div style="font-size: 20px; font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;">
           <span>ğŸ””</span> <span id="notif-title">åˆ°ç«™é€šçŸ¥</span>
        </div>
        <div id="notification-content" style="font-size:15px; line-height:1.5; margin-bottom:15px;">å…§å®¹...</div>
        <button id="btn-notification-ok" class="btn btn-primary" style="width:100%;">æ”¶åˆ°</button>
      </div>
    </div>

    <nav class="bottom-nav">
      <button class="nav-btn active" data-target="home-screen"><div class="nav-icon">ğŸ </div><div>é¦–é </div></button>
      <button class="nav-btn" data-target="stops-screen"><div class="nav-icon">â­</div><div>å¸¸ç”¨</div></button>
      <button class="nav-btn" data-target="reservations-screen"><div class="nav-icon">ğŸ“</div><div>é ç´„</div></button>
      <button class="nav-btn" data-target="route-screen"><div class="nav-icon">ğŸ§­</div><div>è¦åŠƒ</div></button>
      <button class="nav-btn" data-target="others-screen"><div class="nav-icon">ğŸ”</div><div>å…¶ä»–</div></button>
    </nav>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
    import { getFirestore, collection, getDocs, query } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyB1T4agVI78c4vXGLWUBfy5MWo1NwRgEQs",
      authDomain: "busssss-c18d5.firebaseapp.com",
      projectId: "busssss-c18d5",
      storageBucket: "busssss-c18d5.firebasestorage.app",
      messagingSenderId: "1021928933232",
      appId: "1:1021928933232:web:83dd719f9b1112f37031b5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Global Data
    let allRoutesConfig = []; 
    let STOPS = [];
    let RESERVATIONS = [];
    
    // Init
    initDataFromStorage();
    updateWeather();

    function initDataFromStorage() {
      const savedStops = localStorage.getItem('my_bus_stops');
      if (savedStops) STOPS = JSON.parse(savedStops);
      const savedRes = localStorage.getItem('my_bus_reservations_v2'); 
      if (savedRes) RESERVATIONS = JSON.parse(savedRes);
    }

    function saveDataToStorage() {
      localStorage.setItem('my_bus_stops', JSON.stringify(STOPS));
      localStorage.setItem('my_bus_reservations_v2', JSON.stringify(RESERVATIONS));
    }

    // --- Firebase Logic ---
    async function fetchRoutesFromFirebase() {
      const busListEl = document.getElementById("bus-list");
      try {
        const q = query(collection(db, 'bus_routes'));
        const snapshot = await getDocs(q);
        
        allRoutesConfig = []; 
        if (snapshot.empty) return;

        snapshot.forEach(doc => {
          const data = doc.data();
          let isAccessible = Math.random() < 0.3;
          if (data.name && data.name.toString().startsWith('1')) isAccessible = false;
          
          allRoutesConfig.push({ id: doc.id, isAccessible: isAccessible, ...data });
        });

        allRoutesConfig.sort((a, b) => (a.name || "").localeCompare((b.name || ""), undefined, { numeric: true, sensitivity: 'base' }));
        console.log(`Loaded ${allRoutesConfig.length} routes`);
        renderHomePageBusList();  
        renderStopsList();    
      } catch (e) {
        console.error("Firebase Error:", e);
        busListEl.innerHTML = `<div style='padding:20px;text-align:center;color:red;'>é€£ç·šéŒ¯èª¤<br>${e.message}</div>`;
      }
    }

    function randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    // --- Render Logic ---
    function renderHomePageBusList() {
      const busListEl = document.getElementById("bus-list");
      busListEl.innerHTML = "";
      
      if (STOPS.length === 0) {
        busListEl.innerHTML = `<div style="padding:30px;text-align:center;color:#666;">ç›®å‰é‚„æ²’æœ‰å¸¸ç”¨ç«™ç‰Œ<br>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢</div>`;
        return;
      }
      if (allRoutesConfig.length === 0) {
         busListEl.innerHTML = "<div style='padding:20px;text-align:center;'>æ­£åœ¨æ›´æ–°å³æ™‚è³‡è¨Š...</div>";
         return; 
      }

      STOPS.forEach((stop) => {
        const routeInfo = allRoutesConfig.find(r => r.id === stop.routeId);
        let arrivalMin = -1;
        let busName = stop.name;
        let dest = "";
        let isAccessible = false;

        if (routeInfo) {
           busName = routeInfo.name;
           dest = `å¾€ ${routeInfo.dest}`;
           arrivalMin = (routeInfo.baseArrivalMin || 5) + randomInt(-2, 5);
           isAccessible = routeInfo.isAccessible;
           if(arrivalMin < 0) arrivalMin = 0;
        } else {
           dest = stop.direction; 
           arrivalMin = randomInt(1, 15);
           isAccessible = Math.random() > 0.7;
        }

        if (busName && busName.toString().startsWith('1')) isAccessible = false;

        const row = document.createElement("div");
        row.className = "home-bus-row"; 
        
        const isUrgent = arrivalMin <= 3;
        const circleClass = isUrgent ? "arrival-circle urgent" : "arrival-circle";
        let timeHTML = `${arrivalMin}<span>åˆ†</span>`;
        if (arrivalMin <= 0) timeHTML = `é€²<span>ç«™</span>`;

        const accessibleHtml = isAccessible ? '<span class="icon-accessible" title="ç„¡éšœç¤™å…¬è»Š">â™¿</span>' : '';

        row.innerHTML = `
          <div style="display: flex; align-items: center; gap: 15px;">
            <div class="${circleClass}">${timeHTML}</div>
            <div>
              <div class="bus-name">${busName} ${accessibleHtml}</div>
              <div class="bus-dest">${stop.name} (${dest})</div>
            </div>
          </div>
          <div style="color: #ccc; font-size: 20px;">â€º</div>
        `;
        
        row.addEventListener("click", () => {
          openDecisionFor({
             name: busName,
             dest: dest,
             arrivalMin: arrivalMin,
             seatStatus: routeInfo?.baseSeatStatus || "seat",
             isAccessible: isAccessible
          });
        });
        busListEl.appendChild(row);
      });
    }

    // --- Decision Screen Logic ---
    let pendingBusInfo = null;
    let pendingReservationType = null; 

    window.openDecisionFor = function(busInfo) {
       pendingBusInfo = busInfo; 
       setActiveScreen("detail-screen");

       document.getElementById("emoji-bus").textContent = "ğŸšŒ";
       document.getElementById("decision-title").textContent = "åˆ†æå®Œæˆ";
       document.getElementById("decision-subtitle").textContent = `${busInfo.name} ${busInfo.dest}`;
       
       const crowdingLevels = ["èˆ’é©", "æ™®é€š", "ç•¥æ“ ", "æ“æ“ "];
       const crowding = crowdingLevels[Math.floor(Math.random() * crowdingLevels.length)];
       const randomSeats = Math.floor(Math.random() * 10) + 3;
       let seatText = busInfo.seatStatus === 'seat' ? `${randomSeats} å€‹åº§ä½` : 'ç„¡åº§ä½';

       const tag = document.getElementById("decision-tag");
       if (crowding === "æ“æ“ ") {
           tag.className = "decision-tag bad"; 
           tag.innerHTML = "ğŸ”´ ä¸å»ºè­°æ­ä¹˜"; 
       } else if (crowding === "ç•¥æ“ ") {
           tag.className = "decision-tag ok"; 
           tag.innerHTML = "ğŸŸ¡ å°šå¯æ¥å—";
       } else {
           tag.className = "decision-tag good"; 
           tag.innerHTML = "ğŸŸ¢ å»ºè­°æ­ä¹˜";
       }
       
       const accessibleText = busInfo.isAccessible ? ' <span class="icon-accessible">â™¿</span>' : '';
       document.getElementById("bus-name-line").innerHTML = `${busInfo.name}${accessibleText} | ${busInfo.arrivalMin} åˆ†é˜å¾Œåˆ°ç«™`;
       
       document.getElementById("props-list").innerHTML = `
         <li class="props-item"><span class="props-label">å…¬è»Šè·¯ç·š</span><span class="props-value" style="color:var(--color-primary);font-weight:700;">${busInfo.name}</span></li>
         <li class="props-item"><span class="props-label">åˆ°ç«™æ™‚é–“</span><span class="props-value">${busInfo.arrivalMin} åˆ†é˜</span></li>
         <li class="props-item"><span class="props-label">è»Šå»‚ç‹€æ³</span><span class="props-value">${seatText} (${crowding})</span></li>
         <li class="props-item"><span class="props-label">è»Šè¼›é¡å‹</span><span class="props-value">${busInfo.isAccessible ? 'ä½åº•ç›¤å…¬è»Š' : 'ä¸€èˆ¬å…¬è»Š'}</span></li>
       `;
    };

    // --- Reservation Split Logic ---
    const reserveOverlay = document.getElementById("reserve-overlay");
    const notificationOverlay = document.getElementById("notification-overlay");

    document.getElementById("btn-reserve-board").addEventListener("click", () => {
        pendingReservationType = 'boarding';
        document.getElementById("reserve-msg").innerText = "å·²è¨­å®šã€Œä¸Šè»Šæé†’ã€ã€‚\nç•¶å…¬è»Šå³å°‡é€²ç«™æ™‚æœƒé€šçŸ¥æ‚¨ã€‚";
        reserveOverlay.style.display = "flex";
    });

    document.getElementById("btn-reserve-alight").addEventListener("click", () => {
        pendingReservationType = 'alighting';
        document.getElementById("reserve-msg").innerText = "å·²è¨­å®šã€Œä¸‹è»Šæé†’ã€ã€‚\n(æ¨¡æ“¬ï¼šé è¨ˆ 20 åˆ†é˜å¾ŒæŠµé”ç›®çš„åœ°)";
        reserveOverlay.style.display = "flex";
    });
    
    document.getElementById("btn-modal-ok").addEventListener("click", () => {
        if(pendingBusInfo && pendingReservationType) {
            const now = new Date();
            const timeStr = now.getHours() + ":" + (now.getMinutes()<10?'0':'') + now.getMinutes();
            
            let targetTime = 0;
            let displayMin = 0;

            if (pendingReservationType === 'boarding') {
                let arrivalMs = pendingBusInfo.arrivalMin * 60 * 1000;
                if (pendingBusInfo.arrivalMin <= 0) arrivalMs = 5000;
                targetTime = Date.now() + arrivalMs;
                displayMin = pendingBusInfo.arrivalMin;
            } else {
                const travelTimeMin = 20 + randomInt(-5, 5); 
                const arrivalMs = pendingBusInfo.arrivalMin * 60 * 1000;
                targetTime = Date.now() + arrivalMs + (travelTimeMin * 60 * 1000);
                displayMin = pendingBusInfo.arrivalMin + travelTimeMin;
            }

            RESERVATIONS.push({
               id: Date.now(),
               type: pendingReservationType, 
               time: timeStr,
               bus: pendingBusInfo.name,
               dest: pendingBusInfo.dest,
               arrival: displayMin, 
               targetTime: targetTime,
               notified: false
            });
            saveDataToStorage(); 
            renderReservationsList();
        }
        
        reserveOverlay.style.display = "none";
        document.getElementById("detail-screen").classList.remove("active");
        setActiveScreen("reservations-screen");
        setActiveNav("reservations-screen");
    });

    document.getElementById("btn-notification-ok").addEventListener("click", () => {
        notificationOverlay.style.display = "none";
    });

    // Background Check
    function startReservationCheck() {
        setInterval(() => {
            const now = Date.now();
            let hasUpdate = false;

            RESERVATIONS.forEach(res => {
                if (!res.notified && now >= res.targetTime) {
                    showNotification(res);
                    res.notified = true;
                    hasUpdate = true;
                }
            });

            if (hasUpdate) {
                saveDataToStorage();
                renderReservationsList();
            }
        }, 5000);
    }
    
    function showNotification(res) {
        const titleEl = document.getElementById("notif-title");
        const contentEl = document.getElementById("notification-content");
        
        if (res.type === 'boarding') {
            titleEl.innerText = "å…¬è»Šé€²ç«™é€šçŸ¥";
            contentEl.innerHTML = `<strong>${res.bus}</strong> å³å°‡æŠµé”æ‰€åœ¨ç«™ç‰Œ<br>é–‹å¾€ï¼š${res.dest}<br>è«‹æº–å‚™ä¸Šè»Šï¼`;
        } else {
            titleEl.innerText = "åˆ°ç«™ä¸‹è»Šé€šçŸ¥";
            contentEl.innerHTML = `<strong>${res.bus}</strong> å³å°‡æŠµé”ç›®çš„åœ°<br>è«‹æº–å‚™æŒ‰ä¸‹è»Šéˆ´ï¼`;
        }
        notificationOverlay.style.display = "flex";
    }

    function renderReservationsList() {
        const boardEl = document.querySelector("#res-list-boarding .content");
        const alightEl = document.querySelector("#res-list-alighting .content");
        const emptyText = document.getElementById("no-reservation-text");
        
        boardEl.innerHTML = "";
        alightEl.innerHTML = "";
        
        if(RESERVATIONS.length === 0) {
            emptyText.style.display = "block";
            document.getElementById("res-list-boarding").style.display = 'none';
            document.getElementById("res-list-alighting").style.display = 'none';
        } else {
            emptyText.style.display = "none";
            document.getElementById("res-list-boarding").style.display = 'block';
            document.getElementById("res-list-alighting").style.display = 'block';

            RESERVATIONS.forEach(res => {
                const card = document.createElement("div");
                card.className = "card";
                card.style.marginBottom = "10px";
                card.style.padding = "10px";

                const statusText = res.notified ? `<span style="color:#999;">(å·²é€šçŸ¥)</span>` : `<span style="color:#00b894;">â³ ç­‰å¾…ä¸­</span>`;
                const typeText = res.type === 'boarding' ? "ä¸Šè»Š" : "ä¸‹è»Š";
                const typeColor = res.type === 'boarding' ? "#4a69bd" : "#e67e22";

                card.innerHTML = `
                   <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
                      <span style="font-weight:700; color:${typeColor}; border:1px solid ${typeColor}; padding:1px 4px; border-radius:4px;">${typeText}</span>
                      ${statusText}
                   </div>
                   <div style="font-size:15px; font-weight:700;">${res.bus} <span style="font-weight:400; font-size:12px;">å¾€ ${res.dest}</span></div>
                   <div style="font-size:12px; color:#666; margin-top:4px;">è¨­å®šæ™‚é–“ ${res.time}ãƒ»é è¨ˆ ${res.arrival} åˆ†å¾Œ</div>
                   <button style="width:100%; border:none; background:#eee; padding:4px; margin-top:8px; border-radius:4px; font-size:12px; color:#666;" onclick="deleteRes(${res.id})">åˆªé™¤</button>
                `;
                
                if (res.type === 'boarding') boardEl.appendChild(card);
                else alightEl.appendChild(card);
            });
            
            if (boardEl.children.length === 0) boardEl.innerHTML = "<div style='font-size:12px; color:#ccc; padding:5px;'>ç„¡ä¸Šè»Šé ç´„</div>";
            if (alightEl.children.length === 0) alightEl.innerHTML = "<div style='font-size:12px; color:#ccc; padding:5px;'>ç„¡ä¸‹è»Šé ç´„</div>";
        }
    }
    
    window.deleteRes = function(id) {
        RESERVATIONS = RESERVATIONS.filter(r => r.id !== id);
        saveDataToStorage();
        renderReservationsList();
    };

    // --- Food (Random & Selectable) ---
    const foodDatabase = [
        { name: "é˜¿å¬¤å¤æ—©å‘³éºµæ”¤", icon: "ğŸœ", dist: 150, score: 4.5 },
        { name: "äº”æ¡è™Ÿ (ç«™å‰åº—)", icon: "ğŸ¥¤", dist: 50, score: 4.2 },
        { name: "éµè·¯ä¾¿ç•¶æœ¬èˆ–", icon: "ğŸ±", dist: 300, score: 4.0 },
        { name: "å¿«æ¨‚å¤§é›æ’", icon: "ğŸ—", dist: 120, score: 4.7 },
        { name: "å··å£ä¹¾éºµ", icon: "ğŸ", dist: 200, score: 3.8 },
        { name: "è€å¼µç‰›è‚‰éºµ", icon: "ğŸ²", dist: 450, score: 4.3 },
        { name: "å†°æ¶¼è±†èŠ±", icon: "ğŸ§", dist: 80, score: 4.6 },
        { name: "ä¾¿åˆ©è¶…å•†", icon: "ğŸª", dist: 10, score: 3.5 }
    ];

    function updateFoodStopSelect() {
        const select = document.getElementById("food-stop-select");
        select.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
        
        if (STOPS.length === 0) {
            const opt = document.createElement("option");
            opt.textContent = "ç„¡å¸¸ç”¨ç«™ç‰Œ";
            opt.disabled = true;
            select.appendChild(opt);
        } else {
            STOPS.forEach(stop => {
                const opt = document.createElement("option");
                opt.value = stop.name;
                opt.textContent = stop.name;
                select.appendChild(opt);
            });
            // é è¨­é¸å–ç¬¬ä¸€å€‹
            select.value = STOPS[0].name;
        }
        renderFoodList(); // åˆå§‹åŒ–é¸å–å¾Œç›´æ¥æ¸²æŸ“
    }

    function renderFoodList() {
        const container = document.getElementById("food-list-container");
        const select = document.getElementById("food-stop-select");
        
        // å¦‚æœæ²’æœ‰é¸ä»»ä½•æ±è¥¿ï¼Œå°±ä¸é¡¯ç¤º
        if (!select.value && STOPS.length > 0) {
            container.innerHTML = `<div style="text-align:center; padding:10px;">è«‹é¸æ“‡ä¸€å€‹ç«™ç‰Œ</div>`;
            return;
        }

        // éš¨æ©Ÿé¸ 3 å€‹ (æ¨¡æ“¬æœå°‹è©²åœ°é»)
        const shuffled = [...foodDatabase].sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, 3);
        
        container.innerHTML = "";
        selected.forEach(item => {
            const div = document.createElement("div");
            div.className = "food-item";
            // æ¨¡æ“¬è·é›¢å¾®èª¿
            const dist = item.dist + randomInt(-20, 50);
            div.innerHTML = `
                <div class="food-img">${item.icon}</div>
                <div class="food-info">
                    <h4>${item.name}</h4>
                    <div class="food-meta">è·é›¢ ${dist > 0 ? dist : 10}mãƒ»â­ ${item.score}</div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // ç›£è½ä¸‹æ‹‰é¸å–®æ”¹è®Š -> é‡æ–°æ¸²æŸ“ç¾é£Ÿåˆ—è¡¨
    document.getElementById("food-stop-select").addEventListener("change", renderFoodList);

    // --- Navigation & Routing ---
    document.querySelectorAll(".nav-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.target;
        setActiveScreen(target);
        setActiveNav(target);
        
        // åˆ‡æ›åˆ°ã€Œå…¶ä»–ã€é é¢æ™‚ï¼Œæ›´æ–°ä¸‹æ‹‰é¸å–®
        if (target === 'others-screen') {
            updateFoodStopSelect();
        }
      });
    });

    function setActiveScreen(id) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }
    function setActiveNav(id) {
      document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
      const btn = document.querySelector(`.nav-btn[data-target="${id}"]`);
      if(btn) btn.classList.add("active");
    }

    // Google Maps Fix
    document.getElementById("btn-plan-route").addEventListener("click", () => {
        const destInput = document.getElementById("destInput");
        const dest = destInput.value.trim();
        if (!dest) { alert("è«‹è¼¸å…¥ç›®çš„åœ°ï¼"); return; }

        const btn = document.getElementById("btn-plan-route");
        const originalText = btn.innerHTML;
        btn.innerHTML = "ğŸ“¡ å®šä½ä¸­...";
        btn.disabled = true;

        const openMap = (lat, lng) => {
            let url;
            if (lat && lng) {
                url = `https://www.google.com/maps/dir/?api=1&origin=${lat},${lng}&destination=${encodeURIComponent(dest)}&travelmode=transit`;
            } else {
                url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}&travelmode=transit`;
            }
            window.open(url, '_blank');
            btn.innerHTML = originalText;
            btn.disabled = false;
        };

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (p) => openMap(p.coords.latitude, p.coords.longitude),
                (e) => {
                    console.warn("GPS Error", e);
                    alert("ç„¡æ³•å®šä½ï¼Œå°‡ç›´æ¥æœå°‹ç›®çš„åœ°");
                    openMap(null, null);
                },
                { timeout: 5000 }
            );
        } else {
            alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
            openMap(null, null);
        }
    });

    // --- Start & Init ---
    document.getElementById("btn-start").addEventListener("click", goToHome);
    
    function startAutoRedirect() {
      let seconds = 3;
      const countdownEl = document.getElementById("countdown-text");
      const interval = setInterval(() => {
        seconds--;
        if(countdownEl) countdownEl.innerText = `${seconds} ç§’å¾Œè‡ªå‹•é€²å…¥...`;
        if (seconds <= 0) { clearInterval(interval); goToHome(); }
      }, 1000);
    }
    
    function goToHome() {
      const welcomeScreen = document.getElementById("welcome-screen");
      if (welcomeScreen.classList.contains("active")) {
          setActiveScreen("home-screen");
          setActiveNav("home-screen");
          fetchRoutesFromFirebase(); 
      }
    }

    // Add Stop Modal Logic
    const addStopModal = document.getElementById("add-stop-modal");
    const selectRouteFirebase = document.getElementById("select-route-firebase");
    const selectStopFirebase = document.getElementById("select-stop-firebase");

    function openAddModal() {
      addStopModal.style.display = "flex";
      selectRouteFirebase.innerHTML = '<option value="">è¼‰å…¥è³‡æ–™ä¸­...</option>';
      selectStopFirebase.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡è·¯ç·š</option>';
      selectStopFirebase.disabled = true;
      selectStopFirebase.style.backgroundColor = "#f0f0f0";

      if (allRoutesConfig.length === 0) fetchRoutesFromFirebase().then(populateRouteSelect);
      else populateRouteSelect();
    }
    
    document.getElementById("btn-add-stop").addEventListener("click", openAddModal);
    document.getElementById("btn-to-stops-main").addEventListener("click", openAddModal);

    function populateRouteSelect() {
      selectRouteFirebase.innerHTML = '<option value="">è«‹é¸æ“‡è·¯ç·š...</option>';
      allRoutesConfig.forEach(route => {
        const opt = document.createElement("option");
        opt.value = route.id;
        opt.textContent = `${route.name} (å¾€ ${route.dest})`; 
        selectRouteFirebase.appendChild(opt);
      });
    }

    selectRouteFirebase.addEventListener("change", () => {
        const routeId = selectRouteFirebase.value;
        if (!routeId) {
          selectStopFirebase.disabled = true;
          return;
        }
        const route = allRoutesConfig.find(r => r.id === routeId);
        selectStopFirebase.innerHTML = '<option value="">è«‹é¸æ“‡ç«™ç‰Œ...</option>';
        if (route && route.stops) {
          route.stops.forEach(stopName => {
            const opt = document.createElement("option");
            opt.value = stopName;
            opt.textContent = stopName;
            selectStopFirebase.appendChild(opt);
          });
          selectStopFirebase.disabled = false;
          selectStopFirebase.style.backgroundColor = "#fff";
        }
    });

    document.getElementById("btn-add-stop-cancel").addEventListener("click", () => addStopModal.style.display = "none");
    document.getElementById("btn-add-stop-confirm").addEventListener("click", () => {
      const routeId = selectRouteFirebase.value;
      const stopName = selectStopFirebase.value;
      if (!routeId || !stopName) { alert("è«‹å®Œæ•´é¸æ“‡"); return; }
      
      const route = allRoutesConfig.find(r => r.id === routeId);
      STOPS.push({
        id: Date.now(),
        routeId: routeId, 
        routeName: route.name, 
        name: stopName,
        direction: `å¾€ ${route.dest}`,
        isDefault: false
      });
      
      saveDataToStorage();
      renderStopsList();
      renderHomePageBusList(); 
      addStopModal.style.display = "none";
      setActiveScreen("home-screen");
      setActiveNav("home-screen");
    });

    function renderStopsList() {
      const stopsListEl = document.getElementById("stops-list");
      stopsListEl.innerHTML = "";
      if (STOPS.length === 0) {
        stopsListEl.innerHTML = `<div style="font-size:12px;color:#000;">ç›®å‰é‚„æ²’æœ‰å¸¸ç”¨ç«™ç‰Œã€‚</div>`;
        return;
      }
      STOPS.forEach(stop => {
        let routeName = stop.routeName;
        let isAccessible = false;
        if (allRoutesConfig.length > 0) {
           const r = allRoutesConfig.find(x => x.id === stop.routeId);
           if(r) { routeName = r.name; isAccessible = r.isAccessible; }
        }
        if (routeName && routeName.toString().startsWith('1')) isAccessible = false;

        const badgeHtml = routeName ? `<span style="background:var(--color-primary); color:white; padding:2px 6px; border-radius:4px; font-size:12px; margin-right:6px; font-weight:700;">${routeName}</span>` : '';
        const accessibleHtml = isAccessible ? '<span class="icon-accessible">â™¿</span>' : '';

        const card = document.createElement("div");
        card.className = "stop-card card";
        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
               <div style="font-weight:600; font-size:15px; display:flex; align-items:center;">${badgeHtml} ${stop.name} ${accessibleHtml}</div>
               <button class="chip-btn" style="background:#ffe6e6;color:red;" onclick="removeStop(${stop.id})">åˆªé™¤</button>
            </div>
            <div style="font-size:12px; color:#666; margin-top:4px; padding-left: 2px;">${stop.direction}</div>`;
        stopsListEl.appendChild(card);
      });
    }

    window.removeStop = function(id) {
       if(!confirm("ç¢ºå®šåˆªé™¤?")) return;
       STOPS = STOPS.filter(s => s.id !== id);
       saveDataToStorage();
       renderStopsList();
       renderHomePageBusList();
    };
    
    document.getElementById("btn-back").addEventListener("click", () => {
       setActiveScreen("home-screen");
       setActiveNav("home-screen");
    });
    
    // Weather
    function updateWeather() {
        const headerWeatherEl = document.getElementById("header-weather");
        const homeWeatherEl = document.getElementById("weather-text");
        if(homeWeatherEl) homeWeatherEl.innerText = "å®šä½ä¸­...";
        if(headerWeatherEl) headerWeatherEl.innerText = "å®šä½ä¸­...";

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
                    fetch(url).then(res => res.json()).then(data => {
                        const w = data.current_weather;
                        const text = `${w.temperature}Â°C`;
                        if(homeWeatherEl) homeWeatherEl.innerText = `${text}ãƒ»ç›®å‰ä½ç½®`;
                        if(headerWeatherEl) headerWeatherEl.innerText = text;
                    }).catch(e => console.error(e));
                },
                (err) => {
                    const msg = "å®šä½æ¬Šé™å—æ‹’";
                    if(homeWeatherEl) homeWeatherEl.innerText = msg;
                    if(headerWeatherEl) headerWeatherEl.innerText = msg;
                }
            );
        } else {
             if(homeWeatherEl) homeWeatherEl.innerText = "ä¸æ”¯æ´å®šä½";
        }
    }
    document.getElementById("btn-refresh-weather").addEventListener("click", updateWeather);

    // Boot
    startAutoRedirect();
    startReservationCheck();
    renderReservationsList(); 
  </script>
</body>
</html>